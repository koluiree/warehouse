@page "/employees"
@inject ApiClient Api

<h1 class="page-title">Сотрудники и отделы</h1>
<p class="page-subtitle">Справочник сотрудников и организационной структуры.</p>

@if (!string.IsNullOrWhiteSpace(Status))
{
    <section class="card">@Status</section>
}

<div class="grid cols-2">
    <section class="card">
        <h3>Сотрудники</h3>
        <div class="toolbar">
            <button @onclick="Load">Обновить</button>
        </div>
        <table>
            <thead>
                <tr>
                    <th>ФИО</th>
                    <th>Должность</th>
                    <th>Отдел</th>
                    <th>Телефон</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var e in EmployeeList)
                {
                    <tr>
                        <td>@e.FullName</td>
                        <td>@e.Position</td>
                        <td>@e.Department.Name</td>
                        <td>@e.Phone</td>
                    </tr>
                }
            </tbody>
        </table>
    </section>

    <section class="card">
        <h3>Отделы</h3>
        <div class="toolbar">
            <input placeholder="Название отдела" @bind="NewDepartmentName" />
            <input placeholder="Код отдела" @bind="NewDepartmentCode" />
            <button class="btn-primary" @onclick="CreateDepartment">Создать отдел</button>
        </div>
        <table>
            <thead>
                <tr>
                    <th>Код</th>
                    <th>Название</th>
                    <th>Сотрудников</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var d in Departments)
                {
                    <tr>
                        <td>@d.Code</td>
                        <td>@d.Name</td>
                        <td>-</td>
                    </tr>
                }
            </tbody>
        </table>
    </section>
</div>

@code {
    private List<EmployeeDto> EmployeeList { get; set; } = [];
    private List<DepartmentDto> Departments { get; set; } = [];

    private string NewDepartmentName { get; set; } = "";
    private string NewDepartmentCode { get; set; } = "";
    private string Status { get; set; } = "";

    protected override async Task OnInitializedAsync() => await Load();

    private async Task Load()
    {
        EmployeeList = await Api.GetEmployeesAsync();
        Departments = await Api.GetDepartmentsAsync();
    }

    private async Task CreateDepartment()
    {
        if (string.IsNullOrWhiteSpace(NewDepartmentName) || string.IsNullOrWhiteSpace(NewDepartmentCode))
        {
            Status = "Введите название и код отдела.";
            return;
        }

        var ok = await Api.CreateDepartmentAsync(new CreateDepartmentRequest(NewDepartmentName, NewDepartmentCode));
        Status = ok ? "Отдел создан." : "Не удалось создать отдел (нужна роль Admin).";
        await Load();
    }
}
